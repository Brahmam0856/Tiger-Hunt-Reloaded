<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üî• Jungle Hunt: Hunter vs Tiger</title>
  <style>
    canvas { border: 2px solid #222; display: block; margin: 0 auto; }
    body {
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      text-align: center;
      color: white;
      font-family: sans-serif;
    }
    #scoreboard, #chatbox, #controls {
      margin-top: 10px;
    }
    #chatLog {
      height: 100px;
      overflow-y: auto;
      border: 1px solid #ccc;
      background: rgba(0,0,0,0.6);
      padding: 5px;
    }
    #wildfire {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>üêÖ Jungle Hunt: Hunter vs Tiger</h1>
  <canvas id="gameCanvas" width="500" height="400"></canvas>
  <img id="wildfire" src="wildfire.gif" width="500" height="400" style="display:none;" />

  <div id="timer">‚è±Ô∏è Time left: <span id="countdown">60</span> seconds</div>
  <div id="scoreboard">Waiting for players‚Ä¶</div>

  <div id="chatbox">
    <input id="chatInput" placeholder="Say something..." />
    <button onclick="sendChat()">Send</button>
    <div id="chatLog"></div>
  </div>

  <div id="controls">
    <button onclick="restartGame()">üîÅ Retry</button>
  </div>

  <audio autoplay loop id="bgmusic">
    <source src="jungle.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const ws = new WebSocket("ws://localhost:8080");

    const tiger = { x: 200, y: 100, size: 50 };
    const hunter = { x: canvas.width / 2 - 25, y: canvas.height - 60, size: 50 };
    const playerId = "player_" + Math.floor(Math.random() * 10000);

    const tigerImg = new Image();
    const hunterImg = new Image();
    const arrowImg = new Image();
    tigerImg.src = "tiger.png";
    hunterImg.src = "hunter.png";
    arrowImg.src = "arrow.png";

    let missCount = 0;
    let isGameOver = false;
    let countdown = 60;
    let timerInterval;

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      if (data.type === "leaderboard") {
  let maxScore = -1;
  let topPlayer = "";
  for (const [id, score] of Object.entries(data.scores)) {
    if (score > maxScore) {
      maxScore = score;
      topPlayer = id;
    }
  }

  document.getElementById("scoreboard").innerHTML =
    "<strong>üèÜ Leaderboard:</strong><br>" +
    Object.entries(data.scores)
      .map(([id, score]) =>
        id === topPlayer
          ? `<span style='color: gold;'>üåü ${id}: ${score} pts</span>`
          : `${id}: ${score} pts`
      )
      .join("<br>");
} else if (data.type === "chat") {
        const log = document.getElementById("chatLog");
        log.innerHTML += `<div><strong>${data.playerId}:</strong> ${data.message}</div>`;
        log.scrollTop = log.scrollHeight;
      }
    };

    function drawScene() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tigerImg, tiger.x - 25, tiger.y - 25, 50, 50);
      ctx.drawImage(hunterImg, hunter.x, hunter.y, hunter.size, hunter.size);
    }

    function moveTiger() {
      if (!isGameOver) {
        tiger.x = Math.random() * (canvas.width - 50) + 25;
        tiger.y = Math.random() * (canvas.height - 150) + 25;
        drawScene();
      }
    }

    function shootArrow(x, y) {
      let posX = hunter.x + 25;
      let posY = hunter.y;
      const dx = (x - posX) / 15;
      const dy = (y - posY) / 15;
      let step = 0;

      function animate() {
        if (step < 15 && !isGameOver) {
          drawScene();
          ctx.drawImage(arrowImg, posX, posY, 30, 10);
          posX += dx;
          posY += dy;
          step++;
          requestAnimationFrame(animate);
        } else {
          checkHit(x, y);
        }
      }
      animate();
    }

    function checkHit(targetX, targetY) {
      const dx = targetX - tiger.x;
      const dy = targetY - tiger.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist <= tiger.size / 2) {
        ws.send(JSON.stringify({ type: "score", playerId, points: 10 }));
        showBlood(tiger.x, tiger.y);
        moveTiger();
      } 
    }

    function showBlood(x, y) {
      ctx.beginPath();
      ctx.arc(x, y, 25, 0, Math.PI * 2);
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.closePath();
      setTimeout(drawScene, 200);
    }

    function triggerTigerAttack() {
      isGameOver = true;
      const fire = document.getElementById("wildfire");
      fire.style.display = "block";

      setTimeout(() => {
        ctx.fillStyle = "black";
        ctx.globalAlpha = 0.7;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
        ctx.fillStyle = "white";
        ctx.font = "26px sans-serif";
        ctx.fillText("üíÄ The tiger caught you!", 120, 200);
        clearInterval(timerInterval);
      }, 1000);
    }

    function restartGame() {
      missCount = 0;
      isGameOver = false;
      document.getElementById("wildfire").style.display = "none";
      countdown = 60;
      document.getElementById("countdown").textContent = countdown;
      startTimer();
      moveTiger();
    }

    canvas.addEventListener("click", e => {
      if (isGameOver) return;
      shootArrow(e.offsetX, e.offsetY);
    });

    function sendChat() {
      const input = document.getElementById("chatInput");
      if (input.value.trim()) {
        ws.send(JSON.stringify({ type: "chat", playerId, message: input.value }));
        input.value = "";
      }
    }
    let countdown = 60;
    function startTimer() {
      timerInterval = setInterval(() => {
        if (!isGameOver && countdown > 0) {
          countdown--;
          document.getElementById("countdown").textContent = countdown;
        } else if (countdown === 0) {
          triggerTigerAttack();
          clearInterval(timerInterval);
        }
      }, 1000);
    }

    tigerImg.onload = () => {
      drawScene();
      setInterval(moveTiger, 1000);
      startTimer();
    };
  </script>
</body>
</html>