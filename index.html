<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üî• Jungle Hunt: Hunter vs Tiger</title>
  <style>
    body {
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    canvas {
      border: 2px solid #222;
      display: block;
      margin: 20px auto 0;
      background: rgba(0, 0, 0, 0.3);
    }

    #gameWrapper {
      position: relative;
      width: 500px;
      margin: auto;
    }

    #wildfire {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
      display: none;
    }

    #gameOverMessage {
      position: absolute;
      top: 35%;
      left: 0;
      width: 100%;
      color: white;
      font-size: 26px;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      display: none;
      z-index: 11;
    }

    #timer, #scoreboard, #chatbox, #controls {
      margin: 10px auto;
      width: 90%;
      max-width: 500px;
    }

    #chatLog {
      height: 100px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <h1>üêÖ Jungle Hunt: Hunter vs Tiger</h1>
  <div id="gameWrapper">
    <canvas id="gameCanvas" width="500" height="400"></canvas>
    <img id="wildfire" src="wildfire.gif" width="500" height="400" />
    <div id="gameOverMessage">üíÄ The tiger caught you!</div>
  </div>

  <div id="timer">‚è±Ô∏è Time left: <span id="countdown">60</span> seconds</div>
  <div id="scoreboard">üèÜ Waiting for players...</div>

  <div id="chatbox">
    <input id="chatInput" placeholder="Say something..." />
    <button onclick="sendChat()">Send</button>
    <div id="chatLog"></div>
  </div>

  <div id="controls">
    <button onclick="restartGame()">üîÅ Retry</button>
  </div>

  <audio autoplay loop id="bgmusic">
    <source src="jungle.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const ws = new WebSocket("ws://localhost:8080");

    const tiger = { x: 200, y: 100, size: 50 };
    const hunter = { x: canvas.width / 2 - 25, y: canvas.height - 60, size: 50 };
    const playerId = "player_" + Math.floor(Math.random() * 10000);

    const tigerImg = new Image();
    const hunterImg = new Image();
    const arrowImg = new Image();
    tigerImg.src = "tiger.png";
    hunterImg.src = "hunter.png";
    arrowImg.src = "arrow.png";

    let missCount = 0;
    let isGameOver = false;
    let countdown = 60;
    let timerInterval;

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      if (data.type === "leaderboard") {
        document.getElementById("scoreboard").innerHTML =
          "<strong>üèÜ Leaderboard:</strong><br>" +
          Object.entries(data.scores)
                .map(([id, score]) => `${id}: ${score} pts`)
                .join("<br>");
      } else if (data.type === "chat") {
        const log = document.getElementById("chatLog");
        log.innerHTML += `<div><strong>${data.playerId}:</strong> ${data.message}</div>`;
        log.scrollTop = log.scrollHeight;
      }
    };

    function drawScene() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tigerImg, tiger.x - 25, tiger.y - 25, 50, 50);
      ctx.drawImage(hunterImg, hunter.x, hunter.y, hunter.size, hunter.size);
    }

    function moveTiger() {
      if (!isGameOver) {
        tiger.x = Math.random() * (canvas.width - 50) + 25;
        tiger.y = Math.random() * (canvas.height - 150) + 25;
        drawScene();
      }
    }

    function shootArrow(x, y) {
      let posX = hunter.x + 25;
      let posY = hunter.y;
      const dx = (x - posX) / 15;
      const dy = (y - posY) / 15;
      let step = 0;

      function animate() {
        if (step < 15 && !isGameOver) {
          drawScene();
          ctx.drawImage(arrowImg, posX, posY, 30, 10);
          posX += dx;
          posY += dy;
          step++;
          requestAnimationFrame(animate);
        } else {
          checkHit(x, y);
        }
      }

      animate();
    }

    function checkHit(targetX, targetY) {
      const dx = targetX - tiger.x;
      const dy = targetY - tiger.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist <= tiger.size / 2) {
        ws.send(JSON.stringify({ type: "score", playerId, points: 10 }));
        showBlood(tiger.x, tiger.y);
        moveTiger();
      } else {
        missCount++;
        if (missCount >= 3) triggerGameOver();
      }
    }

    function showBlood(x, y) {
      ctx.beginPath();
      ctx.arc(x, y, 25, 0, Math.PI * 2);
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.closePath();
      setTimeout(drawScene, 200);
    }

    function triggerGameOver() {
      isGameOver = true;
      clearInterval(timerInterval);
      document.getElementById("wildfire").style.display = "block";
      document.getElementById("gameOverMessage").style.display = "block";
    }

    function restartGame() {
      missCount = 0;
      isGameOver = false;
      countdown = 60;
      document.getElementById("countdown").textContent = countdown;
      document.getElementById("wildfire").style.display = "none";
      document.getElementById("gameOverMessage").style.display = "none";
      startTimer();
      drawScene();
    }

    canvas.addEventListener("click", e => {
      if (!isGameOver) {
        shootArrow(e.offsetX, e.offsetY);
      }
    });

    function sendChat() {
      const input = document.getElementById("chatInput");
      if (input.value.trim()) {
        ws.send(JSON.stringify({ type: "chat", playerId, message: input.value }));
        input.value = "";
      }
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        if (!isGameOver && countdown > 0) {
          countdown--;
          document.getElementById("countdown").textContent = countdown;
        } else if (countdown === 0) {
          triggerGameOver();
        }
      }, 1000);
    }

    tigerImg.onload = () => {
      drawScene();
      setInterval(moveTiger, 800);
      startTimer();
    };
  </script>
</body>
</html>